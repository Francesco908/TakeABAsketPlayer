-- Load Fluent library
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

-- Variables
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Create persistent image (always visible)
local persistentGui = Instance.new("ScreenGui")
persistentGui.Name = "FluentPersistentButton"
persistentGui.Parent = playerGui
persistentGui.ResetOnSpawn = false
persistentGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
persistentGui.Enabled = true

-- Main button
local imageButton = Instance.new("ImageButton")
imageButton.Name = "PersistentControl"
imageButton.Size = UDim2.fromOffset(70, 70)
imageButton.Position = UDim2.new(0, 20, 0.5, -35)
imageButton.AnchorPoint = Vector2.new(0, 0.5)
imageButton.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
imageButton.BorderSizePixel = 0
imageButton.Image = "rbxassetid://6034684930"
imageButton.ScaleType = Enum.ScaleType.Fit
imageButton.Parent = persistentGui

-- Transparency effect
imageButton.BackgroundTransparency = 0.5
imageButton.ImageTransparency = 0.2

-- Rounded corners
local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0.3, 0)
corner.Parent = imageButton

-- Hover effect
local hoverTween = TweenService:Create(imageButton, TweenInfo.new(0.3), {
    BackgroundTransparency = 0.2,
    ImageTransparency = 0,
    Size = UDim2.fromOffset(75, 75)
})
local normalTween = TweenService:Create(imageButton, TweenInfo.new(0.3), {
    BackgroundTransparency = 0.5,
    ImageTransparency = 0.2,
    Size = UDim2.fromOffset(70, 70)
})

imageButton.MouseEnter:Connect(function()
    hoverTween:Play()
end)
imageButton.MouseLeave:Connect(function()
    normalTween:Play()
end)

-- Dragging variables
local dragging = false
local dragStart = nil
local startPos = nil

-- Drag functions
local function onDragStart(input)
    dragging = true
    dragStart = input.Position
    startPos = imageButton.Position
end

local function onDragEnd(input)
    dragging = false
end

local function onDragMove(input)
    if dragging then
        local delta = input.Position - dragStart
        imageButton.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
end

-- Connect drag events
imageButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        onDragStart(input)
    end
end)

imageButton.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        onDragEnd(input)
    end
end)

imageButton.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        onDragMove(input)
    end
end)

-- Create main window optimized for mobile with larger horizontal size
local Window = Fluent:CreateWindow({
    Title = "üíß Water HUB",
    SubTitle = "Take a Basket Player Edition",
    TabWidth = 180,
    Size = UDim2.fromOffset(480, 360),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

-- Toggle menu function
local function toggleMenu()
    if Window and Window.Root then
        Window.Root.Visible = not Window.Root.Visible
    end
end

-- Click handler
imageButton.MouseButton1Click:Connect(function()
    if not dragging then
        toggleMenu()
    end
end)

-- Rotation animation for water drop
spawn(function()
    local rotation = 0
    while imageButton and imageButton.Parent do
        rotation = rotation + 2
        imageButton.Rotation = rotation
        RunService.Heartbeat:Wait()
    end
end)

-- Intercept LeftControl
local function onKeyDown(key, gameProcessed)
    if key.KeyCode == Enum.KeyCode.LeftControl then
        if persistentGui.Enabled then
            toggleMenu()
            return
        end
    end
end

UserInputService.InputBegan:Connect(onKeyDown)

-- Create tabs
local Tabs = {
    Main = Window:AddTab({ Title = "üõ°Ô∏è Main", Icon = "shield" }),
    Visual = Window:AddTab({ Title = "üëÅÔ∏è Visual", Icon = "eye" }),
    Misc = Window:AddTab({ Title = "üîß Misc", Icon = "settings" }),
    Server = Window:AddTab({ Title = "üåê Server", Icon = "globe" })
}

-- MAIN TAB
Tabs.Main:AddToggle("SpeedBoost", {
    Title = "‚ö° Speed Boost",
    Description = "Increases movement speed",
    Default = false,
    Callback = function(value)
        if player.Character and player.Character:FindFirstChild("Humanoid") then
            if value then
                player.Character.Humanoid.WalkSpeed = 32
            else
                player.Character.Humanoid.WalkSpeed = 16
            end
        end
    end
})

Tabs.Main:AddToggle("AntiTrap", {
    Title = "üö´ Anti Trap",
    Description = "Prevents being trapped by other players",
    Default = false
})

Tabs.Main:AddToggle("GodMode", {
    Title = "üõ°Ô∏è God Mode",
    Description = "Complete invincibility",
    Default = false
})

Tabs.Main:AddToggle("Noclip", {
    Title = "üëª Noclip",
    Description = "Walk through walls",
    Default = false
})

-- VISUAL TAB
Tabs.Visual:AddToggle("ESPPlayers", {
    Title = "üë• Player Highlights",
    Description = "Highlight all players",
    Default = false
})

Tabs.Visual:AddToggle("ESPBox", {
    Title = "üì¶ ESP Box",
    Description = "Show boxes around players",
    Default = false
})

-- MISC TAB
Tabs.Misc:AddSection("üìç Base System")

Tabs.Misc:AddButton({
    Title = "üìç Set Base Position",
    Description = "Set your current position as base",
    Callback = function()
        Fluent:Notify({
            Title = "Base System",
            Content = "Base position set!",
            Duration = 3
        })
    end
})

Tabs.Misc:AddButton({
    Title = "üöÄ Teleport to Base",
    Description = "Return to your saved base position",
    Callback = function()
        Fluent:Notify({
            Title = "Base System",
            Content = "Teleporting to base...",
            Duration = 3
        })
    end
})

-- SERVER TAB
Tabs.Server:AddButton({
    Title = "üîÑ Rejoin Server",
    Description = "Rejoin the current server",
    Callback = function()
        game:GetService("TeleportService"):Teleport(game.PlaceId, player)
    end
})

Tabs.Server:AddButton({
    Title = "üö™ Leave Game",
    Description = "Leave the current game",
    Callback = function()
        player:Kick("Left the game via Water Hub")
    end
})

local playerCountLabel = Tabs.Server:AddParagraph({
    Title = "üë• Players",
    Content = #Players:GetPlayers() .. "/" .. Players.MaxPlayers
})

local pingLabel = Tabs.Server:AddParagraph({
    Title = "üì° Ping",
    Content = "Calculating..."
})

-- Update functions
local function updatePlayerCount()
    playerCountLabel:SetDesc("üë• " .. #Players:GetPlayers() .. "/" .. Players.MaxPlayers)
end

-- Main update loop
RunService.Heartbeat:Connect(function()
    if tick() % 2 < 0.016 then
        updatePlayerCount()
        
        local ping = math.floor(game:GetService("Stats").Network.ServerStatsItem["Data Ping"]:GetValue())
        if ping then
            pingLabel:SetDesc("üì° " .. ping .. "ms")
        end
    end
end)

-- Configure managers
SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
InterfaceManager:SetFolder("FluentMobile")
SaveManager:SetFolder("FluentMobile/config")

Window:SelectTab(1)

Fluent:Notify({
    Title = "üíß Water HUB Loaded",
    Content = "Take a Basket Player Edition Activated!",
    Duration = 5
})

-- Anti-AFK
game:GetService("Players").LocalPlayer.Idled:Connect(function()
    game:GetService("VirtualUser"):CaptureController()
    game:GetService("VirtualUser"):ClickButton2(Vector2.new())
end)

SaveManager:LoadAutoloadConfig()
